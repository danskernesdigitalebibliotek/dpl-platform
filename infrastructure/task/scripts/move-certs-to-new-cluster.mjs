#!/usr/bin/env zx

const namespaces = [
  "aabenraa-main",
  "aalborg-main",
  "aalborg-moduletest",
  "aarhus-main",
  "aarhus-moduletest",
  "aero-main",
  "albertslund-main",
  "albertslund-moduletest",
  "allerod-main",
  "assens-main",
  "ballerup-main",
  "ballerup-moduletest",
  "bibliotek-test-main",
  "bibliotek-test-moduletest",
  "billund-main",
  "bnf-main",
  "bnf-moduletest",
  "bornholm-main",
  "brondby-main",
  "bronderslev-main",
  "canary-main",
  "canary-moduletest",
  "cms-school-main",
  "cms-school-moduletest",
  "customizable-canary-main",
  "customizable-canary-moduletest",
  "dragor-main",
  "egedal-main",
  "esbjerg-main",
  "faaborg-midtfyn-main",
  "favrskov-main",
  "faxe-main",
  "faxe-moduletest",
  "fredensborg-main",
  "fredericia-main",
  "frederiksberg-main",
  "frederikshavn-main",
  "frederikssund-main",
  "fureso-main",
  "gentofte-main",
  "gladsaxe-main",
  "glostrup-main",
  "greve-main",
  "gribskov-main",
  "guldborgsund-main",
  "haderslev-main",
  "halsnaes-main",
  "hedensted-main",
  "helsingor-main",
  "herlev-main",
  "herning-main",
  "herning-moduletest",
  "hillerod-main",
  "hjorring-main",
  "hoje-taastrup-main",
  "holbaek-main",
  "holstebro-main",
  "horsens-main",
  "horsholm-main",
  "hvidovre-main",
  "ikast-brande-main",
  "ishoj-main",
  "jammerbugt-main",
  "kalundborg-main",
  "kerteminde-main",
  "kobenhavn-main",
  "kobenhavn-moduletest",
  "koge-main",
  "kolding-main",
  "laeso-main",
  "langeland-main",
  "lejre-main",
  "lolland-main",
  "lyngby-taarbaek-main",
  "mariagerfjord-main",
  "middelfart-main",
  "morso-main",
  "naestved-main",
  "norddjurs-main",
  "nordfyn-main",
  "nyborg-main",
  "odder-main",
  "odense-main",
  "odense-moduletest",
  "odsherred-main",
  "randers-main",
  "rebild-main",
  "ringkobing-skjern-main",
  "ringsted-main",
  "rodovre-main",
  "roskilde-main",
  "roskilde-moduletest",
  "rudersdal-main",
  "samso-main",
  "silkeborg-main",
  "silkeborg-moduletest",
  "skanderborg-main",
  "skive-main",
  "solrod2-main",
  "sonderborg-main",
  "sonderborg-moduletest",
  "soro-main",
  "staging-main",
  "staging-moduletest",
  "stevns-main",
  "struer-main",
  "svendborg-main",
  "syddjurs-main",
  "sydslesvig-main",
  "sydslesvig-moduletest",
  "taarnby-main",
  "taarnby-moduletest",
  "thisted-main",
  "torshavn-main",
  "vallensbaek-main",
  "varde-main",
  "vejen-main",
  "vejle-main",
  "vesthimmerland-main",
  "viborg-main",
  "vordingborg-main",
];

for await (const namespace of namespaces) {
  await moveCertFromOldToNewCluster(namespace);
}

async function moveCertFromOldToNewCluster(namespace) {
  console.log(`moving ${namespace} certs`);
  const certNames = await $`kubectl get certificate -n ${namespace}  -o custom-columns=NAME:.metadata.name --no-headers --context aks-dplplat01-01`.lines();
  for await (const certname of certNames) {
    if(["varnish-tls", "nginx-tls", "node-tls"].includes(certname)) continue;
    console.log(`${certname}`)
    try {
      await $`kubectl --context aks-dplplat01-01 get secret -n ${namespace} ${certname} -o yaml | yq 'del(.metadata.creationTimestamp)' | yq 'del(.metadata.uid)' | yq 'del(.metadata.resourceVersion)' | kubectl apply -f - --context dplplat02`;
    } catch(error) {
      console.log(error);
    }
  }
  console.log(`done with ${namespace} certs`);
}
