apiVersion: v1
kind: Pod
metadata:
  name: lagoon-cli-pod
  namespace: redeploy-operator
  labels:
    app: lagoon-cli
spec:
  containers:
    - name: lagoon-cli-container
      image: uselagoon/lagoon-cli:latest
      command: ["/bin/sh", "-c"]
      args:
        - |
          if [ -f /config/.lagoon.yml ]; then
            cp /config/.lagoon.yml /root/.lagoon.yml
          fi

          chmod 600 /root/.ssh/id_rsa

          # Install jq
          wget -O jq https://github.com/stedolan/jq/releases/download/jq-1.5/jq-linux64
          chmod +x ./jq
          cp jq /usr/bin

          # Add lagoon config
          /lagoon config add \
            --graphql https://api.lagoon.dplplat01.dpl.reload.dk/graphql \
            --force \
            --ui https://ui.lagoon.dplplat01.dpl.reload.dk \
            --hostname 20.238.147.183 \
            --port 22 \
            --lagoon dplplat01

          # Set dplplat01 as default config
          /lagoon config default --lagoon dplplat01

          function redeployDeployments() {
            FAILED_PRODUCTION_DEPLOYMENTS=$(lagoon raw --raw "query allProjects {
              allProjects {
              name
                environments(type: PRODUCTION) {
                  name
                  deployments(limit: 1) {
                    status
                    created
                  }
                }
              }
            }" | jq -r '.allProjects[] | .name as $name | .environments[].deployments[] | select(.status == "failed") | ($name)')

            echo "Redeploying failed production environments"

            for deployment in $FAILED_PRODUCTION_DEPLOYMENTS; do
              if [[ $deployment =~ "dpl-cms" ]]; then
                continue
              fi
              if [[ $deployment =~ "dpl-bnf" ]]; then
                continue
              fi
              echo "$deployment: deploying"
              lagoon deploy latest -p "$deployment" -e "main" --force
            done
          }

          redeploy = true;
          while [redeploy]
          do
            redeployDeployments;
            redeploy = false;
          done

          sleep 3600
      volumeMounts:
        - name: lagoon-known-hosts
          mountPath: /root/.ssh/known_hosts
          subPath: known_hosts
        - name: lagoon-config-volume
          mountPath: /config
        - name: writable-lagoon-config
          mountPath: /root/config
        - name: lagoon-ssh-key-volume
          mountPath: /root/.ssh/id_rsa
          subPath: id_rsa
          readOnly: true
  volumes:
    - name: lagoon-config-volume
      configMap:
        name: lagoon-config
    - name: writable-lagoon-config
      emptyDir:
        medium: Memory
    - name: lagoon-known-hosts
      configMap:
        name: lagoon-known-hosts
    - name: lagoon-ssh-key-volume
      secret:
        secretName: lagoon-ssh-key
  restartPolicy: Never
