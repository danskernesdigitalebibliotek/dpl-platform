apiVersion: v1
kind: Pod
metadata:
  name: lagoon-cli-pod
  namespace: redeploy-operator
  labels:
    app: lagoon-cli
spec:
  containers:
    - name: lagoon-cli-container
      image: uselagoon/lagoon-cli:latest
      command: ["/bin/sh", "-c"]
      args:
        - |
          if [ -f /config/.lagoon.yml ]; then
            cp /config/.lagoon.yml /root/.lagoon.yml
          fi

          chmod 600 /root/.ssh/id_rsa

          wget -O jq https://github.com/stedolan/jq/releases/download/jq-1.5/jq-linux64
          chmod +x ./jq
          cp jq /usr/bin

          /lagoon config add \
            --graphql https://api.lagoon.dplplat01.dpl.reload.dk/graphql \
            --force \
            --ui https://ui.lagoon.dplplat01.dpl.reload.dk \
            --hostname 20.238.147.183 \
            --port 22 \
            --lagoon dplplat01

          /lagoon config default --lagoon dplplat01

          sleep 3600
      volumeMounts:
        - name: lagoon-known-hosts
          mountPath: /root/.ssh/known_hosts
          subPath: known_hosts
        - name: lagoon-config-volume
          mountPath: /config
        - name: writable-lagoon-config
          mountPath: /root/config
        - name: lagoon-ssh-key-volume
          mountPath: /root/.ssh/id_rsa
          subPath: id_rsa
          readOnly: true
  volumes:
    - name: lagoon-config-volume
      configMap:
        name: lagoon-config
    - name: writable-lagoon-config
      emptyDir:
        medium: Memory
    - name: lagoon-known-hosts
      configMap:
        name: lagoon-known-hosts
    - name: lagoon-ssh-key-volume
      secret:
        secretName: lagoon-ssh-key
  restartPolicy: Never
