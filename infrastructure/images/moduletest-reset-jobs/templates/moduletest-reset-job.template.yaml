# This manifest will fire up a custom Kubernetes Job in moduletest namepaces.
# It will synchronize files and database from the corresponding main environment to the moduletest environment

{{- range .Values.projects }}

apiVersion: batch/v1
kind: Job
metadata:
  name: moduletest-reset-{{ . }}
  labels:
    app: moduletest-reset-job
spec:
  ttlSecondsAfterFinished: 36000 # 10 hours leaving time to investigate failed jobs
  backoffLimit: 3
  template:
    spec:
      restartPolicy: Never
      containers:
        - name: moduletest-reset-container
          image: ghcr.io/danskernesdigitalebibliotek/dpl-platform/moduletest-reset-job:mr-0.0.24-rc
          command:
            - /bin/bash
            - -c
            - ./moduletest-files-reset-job.mjs {{ . }}
  tolerations:
    - key: noderole.dplplatform,
      operator: Equal
      value: prod
      effect: NoSchedule
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
          - matchExpressions:
              - key: noderole.dplplatform
                operator: In
                values:
                  - prod

            
---
{{- end }}
