name: Deploy new release to production sites

on:
  workflow_dispatch: # Allows manual trigger

jobs:
  update-and-deploy:
    name: Update Lagoon Dockerfile and Deploy
    runs-on: ubuntu-latest

    steps:
    # Step 1: Check out the repository containing `sites.yaml`
    - name: Checkout main
      uses: actions/checkout@v3

    - name: Get canary's version from `sites.yaml`
      id: parse-version
      run: |
        NEW_VERSION=$(yq '.sites.canary."dpl-cms-release"' ./infrastructure/environments/dplplat01/sites.yaml)
        echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "Version we're going to update to is: $NEW_VERSION"

    - name: Clone Target Repository
      run: |
        git clone https://${{ secrets.GITHUB_TOKEN }}@github.com/danishpubliclibraries/env-canary

    - name: Check if the dpl-cms-release version changed
      id: check-main-version
      run: |
        CURRENT_VERSION=$(sed -n 's/^FROM ghcr.io\/danskernesdigitalebibliotek\/dpl-cms-source:\([^ ]*\) .*/\1/p' env-canary/lagoon/cli.dockerfile)
        echo "current-version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
        if [ "$CURRENT_VERSION" == "${{ steps.parse-version.outputs.new-version }}" ]; then
          echo "Version is already up-to-date: $CURRENT_VERSION"
          echo "update_needed=false" >> $GITHUB_OUTPUT
        fi
        if [ "$CURRENT_VERSION" != "${{ steps.parse-version.outputs.new-version }}" ]; then
          echo "Update needed. Current version is: $CURRENT_VERSION"
          echo "update_needed=true" >> $GITHUB_OUTPUT
        fi

    - name: Update version in cli.dockerfile
      if: steps.check-main-version.outputs.update_needed == 'true'
      run: |
        echo "The new version is going to be: ${{ steps.parse-version.outputs.new-version }}"
        sed -i "s|FROM ghcr.io/danskernesdigitalebibliotek/dpl-cms-source:.* AS release|FROM ghcr.io/danskernesdigitalebibliotek/dpl-cms-source:${{ steps.parse-version.outputs.new-version }} AS release|" env-canary/lagoon/cli.dockerfile
        cd env-canary
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git commit -am "Update dpl-cms-release to version ${{ steps.parse-version.outputs.new-version }}"
        git push origin main
